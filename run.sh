#!/bin/sh

docker-compose up -d

echo "Gitlab is starting ..."
echo "You can access the site (http://127.0.0.1) after 5 minutes ."


# 更改 Gitlab Pages 的 nginx 代理服务为 127.0.0.1:8000
sleep 300
DOCKER_ID=`docker ps -aq --filter name=docker_gitlab`
if [ ! -z "${DOCKER_ID}" ]; then
    docker exec -u root ${DOCKER_ID} /bin/bash -c "sed -i 's/listen.*/listen 8000;/g;s/server_name.*/server_name 127.0.0.1;/g' /var/opt/gitlab/nginx/conf/gitlab-pages.conf && gitlab-ctl restart nginx"
fi

# Nginx TODO
# Pass everything to pages daemon
#  location / {
#    # 指向pages的发布目录
#    root /var/opt/gitlab/gitlab-rails/shared/pages;
#    index index.html;
#  }


echo "Gitlab is started ."
exit 0
